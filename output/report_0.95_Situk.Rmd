---
title: "1% Weir Escapement Rule"
author: "Sara Miller and Steve Heinl"
date: "February 3, 2022"
output:
   bookdown::pdf_document2:
    fig_caption: yes
    toc: yes
subtitle: Situk River Sockeye Salmon
header-includes: \usepackage{float}
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, 
                      error=FALSE, fig.pos = 'H', out.width = '95%')
```

```{r load}
library(here)
library(fs)
library(tidyverse)
library(knitr)
```

```{r data}
fs::dir_ls(here::here('output/situk/1988_2021/global_missfill'), regexp = "\\.csv$") %>% 
  set_names(nm = (basename(.) %>% 
                    tools::file_path_sans_ext())) %>%
  map(read_csv) -> tbls_situk_global_missfill
fs::dir_ls(here::here('output/situk/2012_2021/global_missfill'), regexp = "\\.csv$") %>% 
  set_names(nm = (basename(.) %>% 
                    tools::file_path_sans_ext())) %>%
  map(read_csv) -> tbls_situk_ten_years_global_missfill
fs::dir_ls(here::here('output/situk/1988_2021/gompertz'), regexp = "\\.csv$") %>% 
  set_names(nm = (basename(.) %>% 
                    tools::file_path_sans_ext())) %>%
  map(read_csv) -> tbls_situk_gompertz
fs::dir_ls(here::here('output/situk/2012_2021/gompertz'), regexp = "\\.csv$") %>% 
  set_names(nm = (basename(.) %>% 
                    tools::file_path_sans_ext())) %>%
  map(read_csv) -> tbls_situk_ten_years_gompertz

```


# Background
There were two objectives in this study.

  1. The first objective was to quantify the date to which the weir would be required to be operated through (e.g., would capture 95% of the escapement with 95% probability; the hard date). The earliest date a project can end is the day after the hard date. 
  
  2. The second objective was to estimate the percent of counts missed if the project was operated following the $x$-day 1% rule (daily counts equal less than 1% of the cumulative count for $x$ days (1, 2, 3, 4, or 5 days) in a row up to and including the hard date). For example, if the hard date is Julian day 247 and days 243 to 247 are <1% of the cumulative counts for 5 days, then the end date for that year would be Julian day 248.   

All associated files, data, and code are located at https://github.com/commfish/weiRends. This work is based upon efforts originally developed by Scott Raborn. The code was originally written by Ben Williams and then adapted by Sara Miller. The code for the EM algorithm was developed by Justin Priest.


## Definitions
*Hard date*: The escapement date that captures 95% of the escapement with 95% probability. The date to which the weir would be required to be operated through. 

*End date* (i.e., expressed as median date): The end date is the estimated day the weir project would have ended in the past if the 1% rule had been in place. The end date is expressed as the median date and as a range (end range) of dates (e.g., 25th–75th percentiles or minimum–maximum). The projected end date and end range can be used for planning purposes.  

# Data Inputs

The input data format is four columns with date (preferably in year-mm-dd format), weir count data, species, and year. 

An example is:  
  date      count   species  year  
2019-07-20    20    Sockeye  2019

This is for a single species at a single weir. 
No other values or comments should be included in the file. 
Data should be provided in .csv format. 

# Methods
Three methods were used to estimate tails of the weir passage when weir operations did not capture the entire escapement particularly the end of the escapement; Gompertz model, logistic model, and the Expectation Maximization (EM) algorithm. 

## Gompertz and logistic models
Two models were considered first:

the Gompertz model 
$$p\mathrm{e}^{{-e}^{-k(t-t_0)}},$$ 
and the logistic model 
$$\frac{p}{\mathrm{1+e}^{-k(t-t_0)}}.$$ 
The variable *p* represents the asymptote of the cumulative escapement, *k* is the steepness of the curve, and *t*~0~ is the inflection point of the curve. These models were used in 1% rule analysis for Bristol Bay and Upper Cook Inlet salmon stocks (Scott Raborn, pers. comm.). 

The evaluation process starts by fitting both models to the cumulative sum of the weir counts, and then the model with the least total variance (i.e., smallest deviance; residual sum of squares of the model) is chosen for the analysis. For each year modeled, the Gompertz model and logistic model are compared to determine the model with the lowest deviance. The model with a greater percentage of the modeled years (each year is modeled separately) with a lower deviance becomes the chosen model. For example, 27 of the 34 modeled years (79%) using the Gompertz model had a lower deviance than the logistic model. Therefore, the Gompertz model was the model used in the Situk River analysis. Cumulative escapement is predicted from the selected model and then this is converted into the number of estimated fish past the weir for a given day. A reconstructed escapement is estimated using observed daily data, filling in any data gaps with estimated daily escapement numbers. This reconstructed escapement is then used to compute a cumulative sum of escapement. The date that a weir should remain in place to capture the 95th percentile of 95% of the escapement is calculated using the reconstructed cumulative sums. Based on the model deviance, the Gompertz model provided an overall better fit to the data than the logistic model. None of the parameter estimates had substantial error bars (Figure \@ref(fig:param-situk-gompertz)) and the models converged for all years. Reconstructed escapements are shown in Figure \@ref(fig:pred-situk-gompertz).

```{r param-situk-gompertz, fig.cap="Parameter estimates from the Gompertz model for Situk River sockeye salmon (1988-2021)."}
knitr::include_graphics(here("figs/situk/1988_2021/gompertz/param_plot.png"))
```


```{r pred-situk-gompertz, fig.cap="Predicted cumulative sockeye salmon escapments, by year, for the Situk River using the Gompertz model (1988-2021). Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir. This is the hard date (17 August or Julian day 229). The circles are the cumulative escapement data and the lines are the predicted cumulative escapements. "}
knitr::include_graphics(here("figs/situk/1988_2021/gompertz/pred_plot.png"))
```

## Expectation-maximization (EM) algorithm
A third method was used to reconstruct escapement using observed historical data to fill data gaps with estimated daily escapement numbers using an iterative procedure (EM algorithm; McLachlan and Krishnan 1997). Missing values of the escapement were filled in under the assumption that the expected count is determined by a given year and Julian day in a multiplicative way. The estimated count for a given Julian day in a given year is equal to the sum of all counts for the particular Julian day times the sum of all counts for the year divided by the sum of all counts over all Julian days and years. If there is more than one missing value, an iterative procedure (as described in Brown 1974) is used since the sums change as missing values are filled in at each step. Reconstructed escapement is then used to compute a cumulative sum of escapement. The date that a weir should remain in place to capture the 95th percentile of 95% of the escapement is calculated using the reconstructed cumulative sums. This method requires observed data as late as possible into the season. The Situk River weir was operated later than 10 August only in 1988 (21 August), 1989 (17 August), 2006 (15 August), 2007 (13 August), and 2016 (11 August). Thus, interpolated values later than 10 August for all years were based largely on run timing in those 5 years. In addition, data cannot be interpolated for days in which no data exist; thus, the latest date escapements could be reconstructed was through 21 August.  Reconstructed escapements are shown in Figure \@ref(fig:pred-situk).

```{r pred-situk, fig.cap="Predicted cumulative sockeye salmon escapements, by year, for the Situk River using an EM Algorithm (1988-2021). Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir. This is the hard date (9 August or Julian day 221). The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/situk/1988_2021/global_missfill/pred_plot.png"))
```

# Results
## 1% Rule (*Hard Date* and *End Date*)  

### Gompertz Model
Using all the data in the time series (1988-2021), the 95th percentile date when 95% of the escapement has passed the weir is Julian day `r tbls_situk_gompertz$run_through$hard_date` or approximately 17 August (the hard date). The earliest date the project can end is Julian day 230 or approximately 18 August (Julian day `r tbls_situk_gompertz$run_through$hard_date` plus one day). Based upon these dates, there is a 95% chance of capturing roughly 96% of the total escapement for the 3-day rule. (number of days; Table \@ref(tab:chance-situk-gompertz)). In addition, there is a 50% chance of capturing about 98% of the escapement for the 3-day rule (number of days; Table \@ref(tab:chance-situk-gompertz)).

The projected median date that the project would end is Julian day 230 (approximately 18 August; end date) for all weir removal rules (Table \@ref(tab:remove-situk-gompertz)). The project end date was based on the entire time series (1988-2021) and estimates of when the weir would have been removed had the 1% rule been used to manage weir operations. The maximum date of weir removal was Julian day 233 (approximately 21 August) using the 3-day 1% rule, and Julian day 234 (approximately 22 August) using the 4-day and 5-day 1% rules (Table \@ref(tab:remove-situk-gompertz)).

```{r chance-situk-gompertz, results = 'asis'}
tbls_situk_gompertz$remove_dates_run_caught %>% 
   knitr::kable(format = 'pandoc', caption = 'The percent of the sockeye salmon escapement that is observed at a given level (% chance) based upon the number of days the 1% rule is implemented for the Situk River based on the Gompertz model (1988-2021).')
```

```{r remove-situk-gompertz, results = 'asis'}
tbls_situk_gompertz$remove_dates_median_end %>% 
   knitr::kable(format = 'pandoc', caption = 'Median and maximum end dates for weir removal based upon number of days to implement the 1% rule for the Situk River based on the Gompertz model (1988-2021).')
```

### EM Algorithm
Using all the data in the time series (1988–2021), the 95th percentile date when 95% of the escapement has passed the weir is  Julian day `r tbls_situk_global_missfill$run_through$hard_date` or 9 August (the hard date). The earliest date the project can end is Julian day 222 or 10 August (Julian day `r tbls_situk_global_missfill$run_through$hard_date` plus one day). Based upon these dates, there is a 95% chance of capturing roughly 95% of the total escapement for the 3-day weir removal rule (number of days; Table \@ref(tab:chance-situk-global-missfill)). In addition, there is a 50% chance of capturing almost 100% of the escapement for the 3-day weir removal rule. 

The projected median date that the project would end is Julian day 229 (approximately 17 August; end date) for the  3-day weir removal rule (Table \@ref(tab:remove-situk-global-missfill)). The project end date was based on the entire time series and estimates of when the weir would have been removed had the 1% rule been used to manage weir operations. The maximum date of weir removal was Julian day 229 (approximately 17 August) using the 3-day 1% rule, Julian day 230 (approximately 18 August) using the 4-day 1% rule, and Julian day 231 (approximately 19 August) using the 5-day 1% rule (Table \@ref(tab:remove-situk-global-missfill)).

\pagebreak

```{r chance-situk-global-missfill, results = 'asis'}
tbls_situk_global_missfill$remove_dates_run_caught %>% 
   knitr::kable(format = 'pandoc', caption = 'The percent of the sockeye salmon escapement that is observed at a given level (% chance) based upon the number of days the 1% rule is implemented for the Situk River (1988-2021) using the EM algorithm.')
```


```{r remove-situk-global-missfill, results = 'asis'}
tbls_situk_global_missfill$remove_dates_median_end %>% 
   knitr::kable(format = 'pandoc', caption = 'Median and maximum end dates for weir removal based upon number of days to implement the 1% rule for the Situk River (1988-2021) using the EM algorithm.')
```

# Discussion
Based on the raw counts, in many years of weir operations, sockeye salmon were still migrating into the river in steady numbers when weir operations ended. For example, in 18 of 30 years, the weir was removed prior to 3 consecutive days with daily weir counts less than 1% of the cumulative count (not including 4 years when the weir was removed prior to 1 August). This also occurred in 5 of the past 10 years (2012–2021). 

The drawbacks to the Gompertz (or logistic) model to reconstruct the escapement are that the escapement tails may be overestimated and results may be affected by the parameters set for the model. For example, one of the model inputs is how far out the lengths of the tails are to be estimated. This can be set, for example, as the latest date of observed weir operations in the time series or 10 days (or more) after this date. Estimated escapement tails were consistently larger using the Gompertz model (see Appendix A Figure \@ref(fig:pred-situk-1990-gompertz) to \@ref(fig:pred-situk-cumsums-gompertz)) compared to the EM algorithm (see Appendix B Figure \@ref(fig:pred-situk-1990-global-missfill) to \@ref(fig:pred-situk-cumsums-global-missfill)); in many of those instances, estimated tails using the Gompertz model extended well beyond what would appear to be reasonable dates for the Situk River. The percent difference between the total raw counts and the counts adjusted by the Gompertz model ranged from 0% (year 1988) to 28% (year 1990) with an average percent change of 11% over all years (see Appendix A Figure \@ref(fig:pred-situk-cumsums-gompertz)). The percent difference between the total raw counts and the counts adjusted by the EM algorithm ranged from <1% (year 1989) to 25% (year 2008) with an average percent change of 8% over all years (see Appendix B Figure \@ref(fig:pred-situk-cumsums-global-missfill)). As a result, the estimated hard date was much later using results from the Gompertz model (`r tbls_situk_gompertz$run_through$hard_date` or approximately 17 August) as compared to using results from the EM algorithm (`r tbls_situk_global_missfill$run_through$hard_date` or 9 August). Conversely, estimated escapements using the EM algorithm performed much better at attenuating the tail of the run. 

The drawbacks to using the EM algorithm include the requirement of a lot of observations late in the season (there are only 5 years in which the weir was operated later than 10 August), and the difficulty in adequately accounting for changes in run timing without recent years of late-season weir operations to include in the analysis. In addition, estimated escapements using the EM algorithm could not exceed 21 August, which was the latest date of observed weir operations. An additional drawback of the EM algorithm is that the estimated escapements in the tails of the run with missing counts had the same cumulative percent. The EM algorithm is adding counts to the tails with missing data so that the cumulative percents are the same across years with raw counts available and years with missing data. This is problematic in that the percent of the run that has passed the weir (by Julian day) is essentially the same across years with missing data in the tails.   

Taking into account the drawbacks of the three methods (Gompertz model, logistic model, or EM algorithm method), we recommend using the estimated hard date of `r tbls_situk_global_missfill$run_through$hard_date` or approximately 9 August, based on the EM algorithm method. We recognize it may not be possible to operate the weir that late in the season every year due to deteriorating weather in August, but this date will serve as a potential, anticipated $run$ $through$ date for each year.


# Conclusions
  1. Based on the EM algorithm method, the hard date, the date to which the weir must be operated through, is Julian day `r tbls_situk_global_missfill$run_through$hard_date` or approximately 9 August. 
  
  2. Based upon the median weir removal date (i.e., end date; Julian day 229 or approximately 17 August), using the number of days to implement the 1% rule for the Situk River, there is a 95% chance of capturing about 95% of the total escapement for the 3-day rule using the EM algorithm method. It may not be possible to operate the weir that late in the season every year due to deteriorating weather in August, but this date will serve as a potential, anticipated $run$ $through$ date for each year.
  
# References
Brown, M. B. 1974. Identification of sources of significance in two-way contingency tables. Applied statistics 23:405-413. 

McLachlan, G. J. and T. Krishnan. 1997. The EM algorithm and extensions. John Wiley and Sons. New York.

# Appendix A - Gompertz Model
```{r pred-situk-1990-gompertz, fig.cap="Predicted cumulative sockeye salmon escapements by year for the Situk River using the Gompertz model. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir. This is the hard date (approximately 17 August or Julian day 229). The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/situk/1988_2021/gompertz/pred_plot_1999year.png"))
```

```{r pred-situk-1991-gompertz, fig.cap="Predicted cumulative sockeye salmon escapements by year for the Situk River using the Gompertz model. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir. This is the hard date (approximately 17 August or Julian day 229). The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/situk/1988_2021/gompertz/pred_plot_2000year.png"))
```

```{r pred-situk-2001-gompertz, fig.cap="Predicted cumulative sockeye salmon escapements by year for the Situk River using the Gompertz model. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir. This is the hard date (approximately 17 August or Julian day 229). The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/situk/1988_2021/gompertz/pred_plot_2010year.png"))
```

```{r pred-situk-cumsums-gompertz, fig.cap="A. Raw and fitted cumulative sums of sockeye salmon weir counts by year, based on the Gompertz model. B. Difference between the raw and fitted cumulative sums of sockeye salmon weir counts by year. The difference between the raw and fitted cumulative sums is the interpolated missing escapement counts."}
knitr::include_graphics(here("figs/situk/1988_2021/gompertz/fitted_plot.png"))
```

# Appendix B - EM Algorithm
```{r pred-situk-1990-global-missfill, fig.cap="Predicted sockeye salmon cumulative escapements by year for the Situk River using the EM algorithm. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir. This is the hard date (approximately 9 August or Julian day 221). The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/situk/1988_2021/global_missfill/pred_plot_1999year.png"))
```

```{r pred-situk-1991-global-missfill, fig.cap="Predicted sockeye salmon cumulative escapements by year for the Situk River using the EM algorithm. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir. This is the hard date (approximately 9 August or Julian day 221). The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/situk/1988_2021/global_missfill/pred_plot_2000year.png"))
```

```{r pred-situk-2001-global-missfill, fig.cap="Predicted sockeye salmon cumulative escapements by year for the Situk River using the EM algorithm. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir. This is the hard date (approximately 9 August or Julian day 221). The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/situk/1988_2021/global_missfill/pred_plot_2010year.png"))
```

```{r pred-situk-cumsums-global-missfill, fig.cap="A. Raw and fitted cumulative sums of sockeye salmon weir counts by year using the EM algorithm. B. Difference between the raw and fitted cumulative sums of sockeye salmon weir counts by year. The difference between the raw and fitted cumulative sums is the interpolated missing escapement counts."}
knitr::include_graphics(here("figs/situk/1988_2021/global_missfill/fitted_plot.png"))
```

