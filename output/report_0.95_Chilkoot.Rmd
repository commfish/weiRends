---
title: "1% Weir Escapement Rule" 
subtitle: "Chilkoot Lake Sockeye Salmon"
author: "Sara Miller and Steve Heinl"
date: "November 2, 2021"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    toc: yes
header-includes:
 \usepackage{float}
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, 
                      error=FALSE, fig.pos = 'H', out.width = '95%')
```

```{r load}
library(here)
library(fs)
library(tidyverse)
library(knitr)
```

```{r data}
fs::dir_ls(here::here('output/chilkoot'), regexp = "\\.csv$") %>% 
  set_names(nm = (basename(.) %>% 
                    tools::file_path_sans_ext())) %>%
  map(read_csv) -> tbls_koot
```


# Background
The objectives of this analysis were to:  

  1.  Model the tails of the escapement to quantify the date to which the weir would be required to be operated through (e.g., would capture 95% of the escapement with 95% probability; the hard date). The earliest date a project can end is the day after the hard date. 
  
  2. Estimate the percent of counts missed if the project was operated following the $x$-day 1% rule (daily counts equal less than 1% of the cumulative count for $x$ days (1, 2, 3, 4, or 5 days) in a row up to and including the hard date). For example, if the hard date is Julian day 247 and days 243 to 247 are <1% of the cumulative counts for 5 days, then the end date for that year would be Julian day 248.   

All associated files, data, and code are located at https://github.com/commfish/weiRends. This work is based upon efforts originally developed by Scott Raborn. The code was originally written by Ben Williams and then adapted by Sara Miller. 


## Definitions
*hard date*: The escapement date that captures 95% of the escapement with 95% probability. The date to which the weir would be required to be operated through. 

*end date*: The end date is the estimated day the weir project would have ended in the past if the 1% rule had been in place. The end date is expressed as the median date and as a range (end range) of dates (e.g., 25th–75th percentiles or minimum–maximum). The projected end date and end range can be used for planning purposes.  

# Data Inputs

The input data format is four columns with date (preferably in year-mm-dd format), weir count data, species, and year. 

An example is:  
  date      count   species  year  
2019-07-20    20    Sockeye  2019

This is for a single species at a single weir. 
No other values or comments should be included in the file. 
Data should be provided in .csv format. 

# Analysis
Two models were considered: 

The Gompertz model 
$$p\mathrm{e}^{{-e}^{-k(t-t_0)}},$$ 
and the logistic model 
$$\frac{p}{\mathrm{1+e}^{-k(t-t_0)}}.$$ 
The variable *p* represents the asymptote of the cumulative escapement, *k* is the steepness of the curve, and *t*~0~ is the inflection point of the curve. 

The evaluation process starts by fitting both models, and then the model with the least total variance is chosen for the analysis. 
*Note that this is a coarse approach and is not a meaningful model comparison*.
Cumulative escapement is predicted from the selected model and then this is converted into the number of estimated fish past the weir for a given day.
A reconstructed escapement is estimated using observed daily data, filling in any data gaps with estimated daily escapement numbers. 
This reconstructed escapement is then used to compute a cumulative sum of escapement. 
The date that a weir should remain in place to capture the 95th percentile of 95% of the escapement is calculated using the reconstructed cumulative sums. Based on the model deviance, the logistic model provided an overall better fit to the data than the Gompertz model. None of the parameter estimates had substantial error bars (Figure \@ref(fig:param-koot)) and the models converged for all years. 

```{r param-koot, fig.cap="Parameter estimates from the logistic model for the Chilkoot River."}
knitr::include_graphics(here("figs/chilkoot/param_plot.png"))
```

```{r pred-koot, fig.cap="Predicted cumulative escapements by year for the Chilkoot River. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir (based on the most recent 10 years of data). This is the hard date. The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/chilkoot/pred_plot.png"))
```


## 1% Rule (*Hard Date* and *End Date*)
Using all years of data, 1976–2021, the 95th percentile date when 95% of the escapement has passed the weir is Julian day 268 (25 September). This date was heavily influenced by, e.g., 1977, 1989, 1997, and 2005-2007, years in which the modeled tails of the escapement appeared to be overestimated (Figures 5–6). In addition, the median date when 95% of the escapement has passed the weir during the most recent 10 years (Julian day 233) was more than 10 days less than the median date over the previous 3 decades (median Julian day 246). To account for earlier recent run timing, we used only the most recent 10 years of data (2012-2021). 

Using only the 10 most recent years of data, the 95th percentile date when 95% of the escapement has passed the weir  is Julian day `r tbls_koot$run_through$end_date` or 4 September (the hard date). The earliest date the project can end is is Julian day 248 or 5 September (Julian day `r tbls_koot$run_through$end_date` plus one day). Based upon these dates, there is a 95% chance of capturing 95-97% of the total escapement for all weir removal rules (number of days; Table \@ref(tab:chance-koot)). In addition, there is a 50% chance of capturing 99% of the escapement. This is also reflected in the percent risk as well (Figure \@ref(fig:risk-koot)); Figure \@ref(fig:risk-koot) reflects the inverse of Table \@ref(tab:chance-koot). For example, a 99% chance is the same as a 1% risk. About 3%  of the escapement is missed (i.e., 97% caught) at a given risk level (99% chance or 1% risk level) based on implementing a 5-day 1% rule. 

The projected median date that the project would end is Julian day 248 (5 September) for all weir removal rules (Table \@ref(tab:remove-koot)). The project end date was based on the 10 most recent years of data and estimates of when the weir would have been removed had the 1% rule been used to manage weir operations. The maximum date of weir removal was Julian day 255 (12 September) using the 5-day 1% rule, Julian day 254 (11 September) using the 4-day 1% rule, and Julian day 250 (7 September) using the 3-day 1% rule (Table \@ref(tab:remove-koot)). 

```{r chance-koot, results = 'asis'}
tbls_koot$remove_dates_run_caught %>% 
   knitr::kable(format = 'pandoc', caption = 'The percent of the escapement that is caught at a given risk level (% chance) based upon the number of days the 1% rule is implemented for the Chilkoot River.')
```


```{r remove-koot, results = 'asis'}
tbls_koot$remove_dates_median_end %>% 
   knitr::kable(format = 'pandoc', caption = 'Median and maximum end dates for weir removal based upon number of days to implement the 1% rule for the Chilkoot River.')
```


```{r risk-koot, fig.cap="The percent of the escapement that will be missed at a given risk level, e.g., about 3\\% of the escapement will be missed 5\\% of the time using a 5-day 1\\% rule for the Chilkoot River."}
knitr::include_graphics(here("figs/chilkoot/remove_dates_risk_plot.png"))
```

# Conclusions
  1. The hard date, the date to which the weir must be operated through, is Julian day `r tbls_koot$run_through$end_date` or 4 September. 
  
  3. Based upon the median weir removal date (end date; Julian day 248 or 5 September), using the number of days to implement the 1% rule for the Chilkoot River, there is a 95% chance of capturing 97% of the total escapement for the 5-day rule. 
  
# Appendix
```{r pred-koot-1990, fig.cap="Predicted cumulative escapements by year for the Chilkoot River. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir (based on the most recent 10 years of data; 2012-2021). This is the hard date. The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/chilkoot/pred_plot_1990year.png"))
```

```{r pred-koot-1991, fig.cap="Predicted cumulative escapements by year for the Chilkoot River. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir (based on the most recent 10 years of data; 2012-2021). This is the hard date. The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/chilkoot/pred_plot_1991year.png"))
```

```{r pred-koot-2001, fig.cap="Predicted cumulative escapements by year for the Chilkoot River. Filled circles indicate 95\\% of the escapement has passed the weir. The vertical line is the 95th percentile date when 95\\% of the escapement has passed the weir (based on the most recent 10 years of data; 2012-2021). This is the hard date. The circles are the cumulative escapement data and the lines are the predicted cumulative escapements."}
knitr::include_graphics(here("figs/chilkoot/pred_plot_2001year.png"))
```

```{r pred-koot-cumsums, fig.cap="A. Raw and fitted cumulative sums of the weir counts by year, based on the logistic model. B. Difference between the raw and fitted cumulative sums of the weir counts by year. The difference between the raw and fitted cumulative sums is the modeled tails."}
knitr::include_graphics(here("figs/chilkoot/fitted_plot.png"))
```
