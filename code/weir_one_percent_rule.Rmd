---
title: "Weir One Percent Rule"
author: "Ben Williams, Sara Miller, and Sarah Power (ben.williams.alaska.gov)"
date: "April 2019"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---
```{r setup, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
```

##Recipient(s)
Steve Heinl

##Background
The objectives of this analysis were to:  1.  Model (Gompertz or logistic) the tails of the run to quantify a hard ending date for weir operations â€“ the date to which the weir would be required to be operated (e.g., would capture 95% of the escapement on average);  2. Estimate % of counts missed (with 95% CI) if project was operated past the hard ending date until daily counts equaled less than 1% of cumulative count for 3, 4, or 5 days in a row.  3. Analyze the Situk River and Chilkoot Lake sockeye salmon weir data to determine the hard ending date the weir is required to be operated and the percent of missed counts if the project was operated past the hard ending date until daily counts equaled less than 1% of cumulative count for 3, 4, or 5 days in a row. All associated files, data, and code are located on GitHub https://github.com/commfish/weiRends.

###Data
The data format is two columns with date (preferably in year-mm-dd format) and weir count data. An example is:
date       count  
2019-01-20  20

This is for a single species at a single weir. No other values or comments should be 
added to the file. It should preferably be in .csv format. 

###Analysis
The Gompertz model is written as $$p\mathrm{e}^{{-e}^{-k(t-t_0)}}$$ and the logistic model is written as $$\frac{p}{\mathrm{1+e}^{-k(t-t_0)}}.$$ 
In the Gompertz model, p represents the asymptote of the cumulative escapement, k is the steepness of the curve, and t~0~ is the inflection point of the curve. 


For the analysis for each stock, all packages need to be loaded (see helper.r file) prior to running models. There are a set of 17 functions that need to be run in order.

1. f_clean_data = formats data for modeling
2. f_gomp_model = runs a Gompertz model for each year
3. f_logistic_model = runs a logistic model for each year
4. f_summary = examine model outputs
5. f_deviance = compare Gompertz and logistic models and proceed with best fitting model; If deviance >0.50, then the Gompertz Model is preferred, and if deviance <0.50, then the logistic model is preferred
6. f_params = get parameter outputs 
7. f_param_plot = plot parameter values 
8. f_preds = predict the model
9. f_pred_plot = examine predictions
10. f_run_through = the weir should be in place through this date
11. f_real_day = change julian date to a date people can understand
12. f_preds_plot95 = examine predictions and 95% cut-off date
13. f_run_caught = percent of the run that is caught at a given risk level
14. f_run_caught_n = number of years included in the percent of the run that is caught at a given risk level
15. f_risk_plot = percent of missed run at a given level of risk (the inverse of # 13)
16. f_run_risk = percent of risk at a given percent of missed run
17. f_median_end_dates = median, 25%, and 75% quantiles of weir removal dates (julian) for 1% rules

Each *stock*_analysis.r file sources the same functions and helper files.

##Methods
The Situk River (years 1988-2018) and Chilkoot Lake (years 1976-2018) sockeye salmon weir data were analyzed to determine the hard ending date the weir is required to be operated based on capturing 95% of the escapement, on average, using historical data. Then, a risk anlysis was performed by calculating the percent of missed counts based on whether the project was operated past the hard ending date until daily counts equaled less than 1% of the cumulative count for 3, 4, or 5 days in a row. 

```{r situk_results}
source('code/helper.r')
source('code/functions.r')
read_csv('data/processed/situk_run_through.csv') -> run_through
read_csv('data/processed/situk_real_day.csv') -> real_day
read_csv('data/processed/situk_dev.csv') -> dev
dev <- round(as.data.frame(dev[1,2]),2)
real_day <- as.data.frame(real_day[1,2])
run_through <- as.data.frame(run_through[1,2])
```


##Results
####Situk River Sockeye Salmon Data
Based on the deviance criterion of `r dev`, the Gompertz model was the preferred model to model the tails of the run. The julian date that 95% of the modeled run has been observed, on average, is julian day `r run_through` (`r real_day`).

Table 1: The percent of the run that is caught at a given risk level. The data from this table are plotted in figure 3.
```{r table1, echo=FALSE}
read_csv('data/processed/run_caught_situk.csv') -> run_caught
run_caught <- as.data.frame(run_caught[,-1])
kable(run_caught)
```

Table 2: The number of years of data included in the percent of the run that is caught at a given risk level. 
```{r table2, echo=FALSE}
read_csv('data/processed/run_caughtn_situk.csv') -> run_caughtn
run_caughtn <- as.data.frame(run_caughtn[,-1])
kable(run_caughtn)
```

Table 3: The percent of missed run at a given level of risk (the inverse of table 1). 
```{r table3, echo=FALSE}
read_csv('data/processed/run_risk_situk.csv') -> run_risk
run_risk <- as.data.frame(run_risk[,-1])
kable(run_risk)
```

Table 4: The median, 25%, and 75% quantiles of weir removal dates (julian day) based on the 1% rules.
```{r table4, echo=FALSE}
read_csv('data/processed/median_end_date_situk.csv') -> median
median <- as.data.frame(median[,-1])
kable(median)
```

```{r fig1, echo=FALSE}
include_graphics("../figs/situk/param_plot.png")
```

Figure 1: Parameter estimates by year for the preferred model. 
\pagebreak

```{r fig2}
include_graphics("../figs/situk/preds_plot95.png")
```

Figure 2: Cumulative escapement by julian date and year with modeled tails. The average 95% (dotted vertical line) and 95% julian date by year (star) are shown. The circles are data.  
\pagebreak

```{r fig3}
include_graphics("../figs/situk/risk_plot.png")
```

Figure 3: The percent of missed run at a given level of risk. The data are shown in table 1.
  \pagebreak

```{r chilkoot_results}
source('code/helper.r')
source('code/functions.r')
read_csv('data/processed/chilkoot_run_through.csv') -> run_through
read_csv('data/processed/chilkoot_real_day.csv') -> real_day
read_csv('data/processed/chilkoot_dev.csv') -> dev
dev <- round(as.data.frame(dev[1,2]),2)
real_day <- as.data.frame(real_day[1,2])
run_through <- as.data.frame(run_through[1,2])
```

####Chilkoot River Sockeye Salmon Data
Based on the deviance criterion of `r dev`, the logistic model was the preferred model to model the tails of the run. The julian date that that 95% of the modeled run has been observed, on average, is `r run_through` (`r real_day`).

Table 5: The percent of the run that is caught at a given risk level. The data are plotted in figure 6.
```{r table5, echo=FALSE}
read_csv('data/processed/run_caught_chilkoot.csv') -> run_caught
run_caught <- as.data.frame(run_caught[,-1])
kable(run_caught)
```

Table 6: The number of years of data included in the percent of the run that is caught at a given risk level. 
```{r table6, echo=FALSE}
read_csv('data/processed/run_caughtn_chilkoot.csv') -> run_caughtn
run_caughtn <- as.data.frame(run_caughtn[,-1])
kable(run_caughtn)
```

Table 7: The percent of missed run at a given level of risk (the inverse of table 1). The data from this table is shown in figure 3.
```{r table7, echo=FALSE}
read_csv('data/processed/run_risk_chilkoot.csv') -> run_risk
run_risk <- as.data.frame(run_risk[,-1])
kable(run_risk)
```

Table 8: The median, 25%, and 75% quantiles of weir removal dates (julian day) based on the 1% rules.
```{r table8, echo=FALSE}
read_csv('data/processed/median_end_date_chilkoot.csv') -> median
median <- as.data.frame(median[,-1])
kable(median)
```

```{r fig4, echo=FALSE}
include_graphics("../figs/chilkoot/param_plot.png")
```

Figure 4: Parameter estimates by year for the preferred model. 
\pagebreak

```{r fig5}
include_graphics("../figs/chilkoot/preds_plot95.png")
```

Figure 5: Cumulative escapement by julian date and year with modeled tails. The average 95% (dotted vertical line) and 95% julian date by year (star) are shown. The circles are data.  
\pagebreak

```{r fig6}
include_graphics("../figs/chilkoot/risk_plot.png")
```

Figure 6: The percent of missed run at a given level of risk. The data are shown in table 5.
  \pagebreak

  
#Recommendations
  
  
  
  \pagebreak
```{r sess_info, echo=FALSE}
#sessionInfo()
```
